<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">TPM Implementation | Archethic</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://archethic-foundation.github.io/archethic-docs/archethic-docs/build/core/cryptography/tpm"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="TPM Implementation | Archethic"><meta data-react-helmet="true" name="description" content="This section explains the HRT TPM Library implementation."><meta data-react-helmet="true" property="og:description" content="This section explains the HRT TPM Library implementation."><link data-react-helmet="true" rel="icon" href="/archethic-docs/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://archethic-foundation.github.io/archethic-docs/archethic-docs/build/core/cryptography/tpm"><link data-react-helmet="true" rel="alternate" href="https://archethic-foundation.github.io/archethic-docs/archethic-docs/build/core/cryptography/tpm" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://archethic-foundation.github.io/archethic-docs/archethic-docs/build/core/cryptography/tpm" hreflang="x-default"><link rel="stylesheet" href="/archethic-docs/assets/css/styles.c6b59544.css">
<link rel="preload" href="/archethic-docs/assets/js/runtime~main.133e5f1a.js" as="script">
<link rel="preload" href="/archethic-docs/assets/js/main.844f4497.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/archethic-docs/"><div class="navbar__logo"><img src="/archethic-docs/img/archethic-white2.png" alt="Archethic Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/archethic-docs/img/archethic-white2.png" alt="Archethic Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Archethic</b></a><a class="navbar__item navbar__link" href="/archethic-docs/learn/archethic-intro">Learn</a><a class="navbar__item navbar__link" href="/archethic-docs/build/smart-contracts">Build</a><a class="navbar__item navbar__link" href="/archethic-docs/research/research-intro">Research</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/archethic-foundation/archethic-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/archethic-docs/learn/archethic-intro">Learn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/archethic-docs/build/smart-contracts">Build</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" tabindex="0" href="/archethic-docs/build/smart-contracts">Smart-Contracts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Smart-Contracts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/archethic-docs/build/sdk/js">SDKs</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/testnet">Testnet</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core">Core development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Core development&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/core/database">Database</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core/p2p/messaging">P2P</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core/cryptography">Cryptography</a><button aria-label="Toggle the collapsible sidebar category &#x27;Cryptography&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/archethic-docs/build/core/cryptography/tpm">TPM Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/core/cryptography/yubikey">Yubikey implementation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core/oracle-chain">OracleChain</a><button aria-label="Toggle the collapsible sidebar category &#x27;OracleChain&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core/beacon-chain">BeaconChain</a><button aria-label="Toggle the collapsible sidebar category &#x27;BeaconChain&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" tabindex="0" href="/archethic-docs/build/core/mining">Mining</a><button aria-label="Toggle the collapsible sidebar category &#x27;Mining&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/core/account">Account</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/core/bootstrap">Bootstrap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/archethic-docs/build/core/election">Election</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/archethic-docs/build/clients/wallet-spec">Client documentation</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/archethic-docs/contributing">Contributing</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>TPM Implementation</h1></header><p>This section explains the HRT TPM Library implementation. </p><div class="admonition admonition-success alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>success</h5></div><div class="admonition-content"><p>Reference Files:
<a href="https://github.com/UNIRIS/tpm-core/blob/main/uniris-tpm.c" target="_blank" rel="noopener noreferrer">uniris-tpm.c</a>
<a href="https://github.com/UNIRIS/tpm-core/blob/main/uniris-tpm.h" target="_blank" rel="noopener noreferrer">uniris-tpm.h</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="global-variables">Global Variables<a class="hash-link" href="#global-variables" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>The global variables are defined as static to maintain the static lifecycle of the global variable, to prevent data leak and external access of the variables.</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="void-keytoasn">void keyToASN():<a class="hash-link" href="#void-keytoasn" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>This function converts raw elliptical public key generated by TPM   to ASN1 DER encoding. </p></div></div><p>TPM generated uncompressed public key does not include the curve information required for elliptic key cryptography. keyToASN() encodes the raw public key by appending curve information to it.</p><p>The ASN DER Public Key is an outer structure which contains 2 inner structures. First inner structure having key type and curve type and second inner structure containning the raw key. The structure containning public key is a header containing <!-- -->[0x00 0x04 x coordinate y coordinate]<!-- -->.</p><p>The following structure  is the format of ASN DER: </p><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>ASN DER Public Key = [ <!-- -->[ [keytype] [curvetype] ][publickey]<!-- --> ]</p></div></div><p><strong>Logic Flow:</strong>
The function adds the headers squentially and then the raw x coordinate of public key and then the y coordinate finally the size is updated.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="void-signtoasnbyte-r-int-sizer-byte-s-int-sizes-int-asnsignsize">void signToASN(BYTE <em>r, INT sizeR, BYTE </em>s, INT sizeS, INT *asnSignSize)<a class="hash-link" href="#void-signtoasnbyte-r-int-sizer-byte-s-int-sizes-int-asnsignsize" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-success alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>success</h5></div><div class="admonition-content"><p>Converts uncompressed signature values to ASN DER format.</p></div></div><p>TPM generates the raw signature in form of integer values : R &amp; S. signToASN() converts these raw values  into ASN DER format. It first prepends the ASN sequence then checks the MSB of R .  If it is 1 then it prepends a byte (0) to R otherwise it move on to increase the index pointed to the asn by the size of R.
Similarly, it does the above for S.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="void-generatepublickeyint-keyindex">void generatePublicKey(INT keyIndex)<a class="hash-link" href="#void-generatepublickeyint-keyindex" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Generates public key on the endorsement key hierarchy of TPM by taking one byte key index as input.</p></div></div><p>Firstly, the template of the public key is defined in the inPublicECC which contains the endorsement key template such that certificate on the keys can be generated except modifying the endorsement key object attributes.
The inPublicECC structure defines the following sub-structure:</p><ol><li>publicArea : defines the attributes of the public key to be generated. For endorsement key the signing operation is restricted due to privacy concern, defined under this structure.  In this case we are generating key in the endordement hierarchy by using the template of the endorsement key.</li></ol><ul><li>The object attributes of generating key are as follows:</li></ul><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_USERWITHAUTH: Signifies the approval of &quot;USER&quot; actions with associated with the public key with a password.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_ADMINWITHPOLICY: Signifies the Approval of &quot;ADMIN&quot; role actions with this object may only be done with a policy session.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_SIGN_ENCRYPT: For a symmetric cipher object, the private portion of the key be used to encrypt. For other objects, the private portion of the key can be used to sign.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_DECRYPT:The private portion of the key can be used to decrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_FIXEDTPM: Indicates that the hierarchy of the key genrated cannot be changed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_FIXEDPARENT:Indicates that the parent of the object cannot be changed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* TPMA_OBJECT_SENSITIVEDATAORIGIN: Indicates that the sensitive data is generated by the TPM on the key generation except the authvalue.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">.objectAttributes = (TPMA_OBJECT_USERWITHAUTH |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_ADMINWITHPOLICY |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_SIGN_ENCRYPT |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_DECRYPT |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_FIXEDTPM |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_FIXEDPARENT |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_SENSITIVEDATAORIGIN),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Object attributes for generating under Endorsement key hierarchy:<ul><li>TPMA_OBJECT_RESTRICTED:  Key usage is restricted to manipulate structures of known format.</li></ul></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Endorsement key has same template except that there is no SIGN_ENCRYPT FLAG in the object attribute.</p></div></div><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">.objectAttributes = (TPMA_OBJECT_RESTRICTED |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_ADMINWITHPOLICY |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_DECRYPT |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_FIXEDTPM |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_FIXEDPARENT |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TPMA_OBJECT_SENSITIVEDATAORIGIN),</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="2"><li>authPolicy: this substructure contains a 32 byte buffer with values exactly same  as endorsement key attributes. This parameter associates the generated key template to the TPM hence during certificate generation the CA is able to return the certificate for the public key generated under Endorsement key hierarchy.</li></ol><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">.authPolicy = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .size = 32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .buffer = {0x83, 0x71, 0x97, 0x67, 0x44, 0x84, 0xB3, 0xF8, 0x1A, 0x90, 0xCC,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           0x8D, 0x46, 0xA5, 0xD7, 0x24, 0xFD, 0x52, 0xD7, 0x6E, 0x06, 0x52,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           0x0B, 0x64, 0xF2, 0xA1, 0xDA, 0x1B, 0x33, 0x14, 0x69, 0xAA}},</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="4"><li>parameters: In the parameter structure we define the algorithm to be used for private key cryptography and public key cryptography operations.</li></ol><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> .parameters.eccDetail = {.symmetric = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         .algorithm = TPM2_ALG_AES,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         .keyBits.aes = 128,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         .mode.sym = TPM2_ALG_CFB,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     .scheme = {.scheme = TPM2_ALG_NULL, .details = {.ecdsa = {.hashAlg = TPM2_ALG_SHA256}}},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     .curveID = TPM2_ECC_NIST_P256,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     .kdf = {.scheme = TPM2_ALG_NULL, .details = {}}},</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> After definning the template of the public key, a unique data is passed to each key in the unique structure of inPublicEC which is root key hash and key index. For the root key the root key hash is 0 and key index is 0. </p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">.unique.ecc = {.x = {.size = 32, .buffer = {0}}, .y = {.size = 32, .buffer = {0}}},</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The primary key is created by using Esys_CreatePrimary() function with the following parameters:</p><ul><li>ESYS_TR_RH_ENDORSEMENT: To generate key in the endorsement hierarchy6.</li><li>ESYS_TR_PASSWORD: indicates a password authorization</li><li>inPublicECC: the public key template defined is passed.</li></ul><p>Finally the created key is converted to ASN DER format.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="setrootkey">setRootKey()<a class="hash-link" href="#setrootkey" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>Initializes root key by calling generatePublicKey(0) since 0 is the index of root key.</p></div></div><p>It also sets the root key hash. It is calculated by concatenating the raw x and y part of the root key and then hashing it.</p><p>The rootkey hash is stored statically and is important for every new primary key generation since it is passed as parameter to the unique structure of inPublicEC.X part. The key index is passed as parameter to the inpublicEc.y.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="updatehandlesindexes">updateHandlesIndexes()<a class="hash-link" href="#updatehandlesindexes" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-success alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>success</h5></div><div class="admonition-content"><p>Increments the current index value by 1 and also updates all the corresponding keys.</p></div></div><p>Flushes the previous key handles index and points it to the nextKeyHandle  then increments NEXT index by 1 to store it in the nextkeyindex. Then generates a new public key by sending nextkeyIndex as the parameter. Finally it assigns the currentKeyhandle to the nextkey handle .</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="initializetpmint-keyindex">initializeTPM(INT keyIndex):<a class="hash-link" href="#initializetpmint-keyindex" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Initializes TPM  context by calling Esys_Initialize() function and sets the previous key handle and nextkey handle as null. Then it sets the root key and key index.</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="getkeyindex">getKeyIndex():<a class="hash-link" href="#getkeyindex" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Returns previous key index because that is the &quot;current&quot; key index used for performing signature.</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="setkeyindexint-keyindex">setKeyIndex(INT keyIndex):<a class="hash-link" href="#setkeyindexint-keyindex" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>Sets the previous key index (which is our current key) to the key index passed as parameter.</p></div></div><p>Also sets keyIndex+1 as the nextKey index.</p><p>For the key generated at after first  initialization it flushes the previous key handle and generates the key with keyIndex then points then populates the previous key handle with the current key handle value.
Next it generates the public key with keyIndex+1 and stores it in the nextkey handle. </p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="getpublickeyint-keyindex-int-publickeysize">getPublicKey(INT keyIndex, INT *publicKeySize):<a class="hash-link" href="#getpublickeyint-keyindex-int-publickeysize" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-success alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>success</h5></div><div class="admonition-content"><p>Returns the public key for the given index.</p></div></div><p>Takes keyIndex and returns root key if the keyINDEX is 0, next key if the keyindex matches with the nextKey index,  previous key if the keyINdex matches with the previous Key index. </p><p>If it matches with none of these indexes, then it flushes the root key from the tpm (due to the limit of max 3 transient handles), generates the key for the corresponding keyIndex and copies it into temp key then flushes it from the TPM. Finally, it regenerates the root key and then returns temp key.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="signecdsaint-keyindex-byte-hashtosign-int-eccsignsize-bool-increment">signECDSA(INT keyIndex, BYTE <em>hashToSign, INT </em>eccSignSize, bool increment):<a class="hash-link" href="#signecdsaint-keyindex-byte-hashtosign-int-eccsignsize-bool-increment" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Signs the given hash using the key referred by the key index.</p></div></div><p>Converts the byte  hash to TPM2B_hash object and then checks the key index . If it is root key or previous key then assigns it to the signing key handle otherwise; </p><p>Sets the previous key index to the given keyindex  by calling setkeyindex() function and assigns it to the signing handle. It signs the hash using Esys_Sign() function. Finally the signature is converted to ASN DER format which is returned by signECDSA().</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="getecdhpointint-keyindex-byte-euphemeralkey">getECDHPoint(INT keyIndex, BYTE *euphemeralKey):<a class="hash-link" href="#getecdhpointint-keyindex-byte-euphemeralkey" title="Direct link to heading">â€‹</a></h2><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Performs Elliptic Curve Diffe Hellmen Key Exchange using the private part of the key referred by the Key Index and public euphemeral key. Returns the derived shared secret uncompressed point.</p></div></div><p>Takes the key index and checks whether it&#x27;s previous key, next key or root key. If it&#x27;s one of these then it assigns it to the  ECDH key handle  else it removes the root key and generates a new key for the given key index and use it in the ECDH handle. </p><p>Next, it re-structures the euphemeral key with the format 04 x y and generates an ECDH point using the Esys_ECDH_ZGen() function and stores it 04 x y format in zPoint which is then returned by the function.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-05-12T13:35:09.000Z">5/12/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/archethic-docs/build/core/cryptography"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cryptography</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/archethic-docs/build/core/cryptography/yubikey"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Yubikey implementation</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#global-variables" class="table-of-contents__link toc-highlight">Global Variables</a></li><li><a href="#void-keytoasn" class="table-of-contents__link toc-highlight">void keyToASN():</a></li><li><a href="#void-signtoasnbyte-r-int-sizer-byte-s-int-sizes-int-asnsignsize" class="table-of-contents__link toc-highlight">void signToASN(BYTE <em>r, INT sizeR, BYTE </em>s, INT sizeS, INT *asnSignSize)</a></li><li><a href="#void-generatepublickeyint-keyindex" class="table-of-contents__link toc-highlight">void generatePublicKey(INT keyIndex)</a></li><li><a href="#setrootkey" class="table-of-contents__link toc-highlight">setRootKey()</a></li><li><a href="#updatehandlesindexes" class="table-of-contents__link toc-highlight">updateHandlesIndexes()</a></li><li><a href="#initializetpmint-keyindex" class="table-of-contents__link toc-highlight">initializeTPM(INT keyIndex):</a></li><li><a href="#getkeyindex" class="table-of-contents__link toc-highlight">getKeyIndex():</a></li><li><a href="#setkeyindexint-keyindex" class="table-of-contents__link toc-highlight">setKeyIndex(INT keyIndex):</a></li><li><a href="#getpublickeyint-keyindex-int-publickeysize" class="table-of-contents__link toc-highlight">getPublicKey(INT keyIndex, INT *publicKeySize):</a></li><li><a href="#signecdsaint-keyindex-byte-hashtosign-int-eccsignsize-bool-increment" class="table-of-contents__link toc-highlight">signECDSA(INT keyIndex, BYTE <em>hashToSign, INT </em>eccSignSize, bool increment):</a></li><li><a href="#getecdhpointint-keyindex-byte-euphemeralkey" class="table-of-contents__link toc-highlight">getECDHPoint(INT keyIndex, BYTE *euphemeralKey):</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/archethic-foundation/archethic-node" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Archethic Node<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/archethic-foundation/libjs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Archethic Javascript SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/archethic-foundation/archethic-wallet" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Archethic Wallet<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Archethic Foundation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/archethic-docs/assets/js/runtime~main.133e5f1a.js"></script>
<script src="/archethic-docs/assets/js/main.844f4497.js"></script>
</body>
</html>